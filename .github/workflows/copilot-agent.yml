name: Copilot Agent Environment

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip running tests (useful for faster setup)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # .NET Setup
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # Python Setup
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install -r scripts/requirements.txt

      # Node.js Setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install Node.js validation tools
        run: npm install -g html-validate pa11y-ci http-server

      # PowerShell Core (already available on ubuntu-latest)
      - name: Verify PowerShell
        run: pwsh --version

      # .NET Dependencies
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore .NET dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Generate site
        run: dotnet run --project src/SiteGenerator/SiteGenerator.csproj --no-build --configuration Release

      # Playwright Setup
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('tests/Site.PlaywrightTests/Site.PlaywrightTests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pwsh tests/Site.PlaywrightTests/bin/Release/net10.0/playwright.ps1 install chromium

      # Validation (optional, based on input)
      - name: Run unit tests
        if: inputs.skip_tests != 'true'
        run: dotnet test tests/SiteGenerator.Tests/SiteGenerator.Tests.csproj --no-build --configuration Release --verbosity normal

      - name: Run Playwright E2E tests
        if: inputs.skip_tests != 'true'
        run: dotnet test tests/Site.PlaywrightTests/Site.PlaywrightTests.csproj --no-build --configuration Release --verbosity normal

      - name: Validate HTML
        if: inputs.skip_tests != 'true'
        run: html-validate 'output/**/*.html'

      - name: Check links in generated site
        if: inputs.skip_tests != 'true'
        uses: lycheeverse/lychee-action@v2
        with:
          args: --verbose --no-progress --exclude '^mailto:' --root-dir output 'output/**/*.html'
          fail: true

      - name: Run accessibility tests
        if: inputs.skip_tests != 'true'
        run: bash scripts/run-a11y-tests.sh

      # Summary
      - name: Environment Summary
        run: |
          echo "## Environment Setup Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Tools" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… .NET: $(dotnet --version)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Node.js: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… npm: $(npm --version)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PowerShell: $(pwsh --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python Packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pip list | grep -E "huggingface|Pillow" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Node.js Global Packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm list -g --depth=0 | grep -E "html-validate|pa11y-ci|http-server" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Playwright Browsers" >> $GITHUB_STEP_SUMMARY
          if [ -d ~/.cache/ms-playwright ]; then
            echo "- âœ… Browsers cached at ~/.cache/ms-playwright" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ No browser cache found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Site" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Site generated successfully in \`output/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ Total HTML files: $(find output -name '*.html' | wc -l)" >> $GITHUB_STEP_SUMMARY

      - name: Upload generated site artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-site
          path: output/
          retention-days: 7

      - name: Upload test results
        if: always() && inputs.skip_tests != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/TestResults/**/*.trx
            tests/Site.PlaywrightTests/bin/Release/net10.0/playwright-results/**
          retention-days: 7
